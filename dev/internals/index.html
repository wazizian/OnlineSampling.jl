<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Internals · OnlineSampling.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">OnlineSampling.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../start/">Getting Started</a></li><li><a class="tocitem" href="../visu/">JuliaCon22</a></li><li><a class="tocitem" href="../library/">Library</a></li><li class="is-active"><a class="tocitem" href>Internals</a><ul class="internal"><li><a class="tocitem" href="#Synchronous-programming"><span>Synchronous programming</span></a></li><li><a class="tocitem" href="#Probabilistic-programming"><span>Probabilistic programming</span></a></li><li><a class="tocitem" href="#Symbolic-inference"><span>Symbolic inference</span></a></li><li><a class="tocitem" href="#Streaming-Belief-Propagation"><span>Streaming Belief Propagation</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Internals</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Internals</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/wazizian/OnlineSampling.jl/blob/main/docs/src/internals.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Internals"><a class="docs-heading-anchor" href="#Internals">Internals</a><a id="Internals-1"></a><a class="docs-heading-anchor-permalink" href="#Internals" title="Permalink"></a></h1><h2 id="Synchronous-programming"><a class="docs-heading-anchor" href="#Synchronous-programming">Synchronous programming</a><a id="Synchronous-programming-1"></a><a class="docs-heading-anchor-permalink" href="#Synchronous-programming" title="Permalink"></a></h2><p>This package relies on Julia&#39;s metaprogramming capabilities.  Under the hood, the macro <code>@node</code> generates three functions.</p><p>A definition,</p><pre><code class="language-julia hljs">@node function f(x::T)::R
    ...
end</code></pre><p>yields:</p><pre><code class="language-julia hljs">f(state::S, isinit::Bool, x::T)::Tuple{S, R}
f_init(x::T)::Tuple{S, R}
f_not_init(state::S, x::T)::Tuple{S, R}</code></pre><p>The resulting functions implement a stateful stream processor which closely mimic the <code>Iterator</code> interface of Julia.</p><ul><li>the function <code>f</code> only dispatches to the two versions <code>f_init</code> and <code>f_not_init</code> depending on whether the argument <code>isinit</code> is equal to true, i.e. on whether <span>$t = 0$</span>.</li><li>given the first input, <code>f_init</code> (the initialization function) is executed at the first step and returns the initial state and the first output.</li><li>then at each step, given the current state and an input, <code>f_no_init</code> (the transition function) computes the next state and the return value.  </li></ul><p>The state correspond to the memory used to store all the variables declared with <code>@init</code> and access via <code>@prev</code>.</p><p>The heavy lifting to create these functions is done by a Julia macro which acts on the Abstract Syntax Tree (AST). The transformations at this level include :</p><ul><li>Creating the two versions of the function.</li><li>Implementing the initialization of the state of a node at <span>$t = 0$</span>.</li><li>Augmenting returns with the next state of the node</li><li>For <span>$t &gt; 0$</span>, adding the code to retrieve the previous internal state and update it.</li><li>Handling calls to other nodes, which are indicated by <code>@nodecall</code>.</li></ul><p>However, some transformations are best done at a later stage of the Julia pipeline.  One of them is the handling of calls to <code>@prev</code> during the initial step <span>$t = 0$</span>. At this point, for any expression <code>e</code>, <code>@prev(e)</code> is undefined and all the code which depends on this call is invalidated and thus is not executed.  To seemlessly handle the various constructs of the Julia language, the precise semantic of this operation and its implementation are done at the level of Intermediate Representation (IR) thanks to the package <code>ÌRTools</code>.</p><h2 id="Probabilistic-programming"><a class="docs-heading-anchor" href="#Probabilistic-programming">Probabilistic programming</a><a id="Probabilistic-programming-1"></a><a class="docs-heading-anchor-permalink" href="#Probabilistic-programming" title="Permalink"></a></h2><p>To add probabilistic constructs, nodes take an extra argument: a context object which describes the inference algorithm in use; and return an extra output: the current loglikelihood, potentially updated with <code>@observe</code> statements.</p><p>The Julia macro thus add the following transformations:</p><ul><li>Augmenting returns with the current log-likelihood.</li><li>Calling the SMC or symbolic algorithms when needed.</li><li>Replacing <code>@observe</code> and <code>rand</code> operations with custom functions which update the ambient log-likelihood and modify the symbolic structure accordingly.</li></ul><h2 id="Symbolic-inference"><a class="docs-heading-anchor" href="#Symbolic-inference">Symbolic inference</a><a id="Symbolic-inference-1"></a><a class="docs-heading-anchor-permalink" href="#Symbolic-inference" title="Permalink"></a></h2><p>When a symbolic inference engine is used, <code>rand</code> add a symbolic variable to an ambient factor graph and return an object referencing this variables.  For instance, when a multivariate Gaussian is sampled, the returned object supports linear operations since the resulting random variable remains Gaussian.  However, when an unsupported operation, e.g. a non linear function such as <code>atan</code>, is applied to a random variable, this variable must be sampled. This automatic realization of a variable undergoing an unsupported transform is also triggered at IR level: when a function is applied to a random variable and there is no method matching the variable type, this variable is automatically sampled.</p><p>This allows random variables to be passed around in tuples, structures or as function arguments while painlessly giving up symbolic inference when it is not possible anymore.</p><h2 id="Streaming-Belief-Propagation"><a class="docs-heading-anchor" href="#Streaming-Belief-Propagation">Streaming Belief Propagation</a><a id="Streaming-Belief-Propagation-1"></a><a class="docs-heading-anchor-permalink" href="#Streaming-Belief-Propagation" title="Permalink"></a></h2><p>We provide a &quot;pointer-minimal&quot; implementation of belief propagation: during execution when a random variables is not referenced anymore by the program, it can be freed by the garbage collector (GC).  In other words, the symbolic factor graph does not get in the way of the GC.  This is done gracefully thanks to the <code>Ref</code> mechanism in Julia, which give us the flexibility of pointers while retaining the convenience of a GC.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../library/">« Library</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.22 on <span class="colophon-date" title="Wednesday 24 August 2022 14:12">Wednesday 24 August 2022</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
